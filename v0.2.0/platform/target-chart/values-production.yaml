# Production Environment - Full Platform Stack
# KubriX-style configuration with clean, simple structure

# Default repository configuration
default:
  repoURL: 'https://github.com/pnow-devsupreme/pn-infra.git'
  targetRevision: 'main'

# Global configuration
global:
  automated:
    prune: true
    selfHeal: true
  retry:
    limit: 3
    backoff:
      duration: 5s
      factor: 2
      maxDuration: 3m

# Platform applications with sync wave ordering
applications:
# Infrastructure Foundation (negative waves deploy first)

- name: ingress-nginx
  annotations:
    argocd.argoproj.io/sync-wave: "-30"
  sources:
  - repoURL: https://kubernetes.github.io/ingress-nginx
    chart: ingress-nginx
    targetRevision: 4.11.3
    helm:
      releaseName: ingress-nginx
      valueFiles:
      - $values/v0.2.0/platform/charts/ingress-nginx/values.yaml
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    ref: values
  destinationNamespaceOverwrite: ingress-nginx

- name: cert-manager
  annotations:
    argocd.argoproj.io/sync-wave: "-20"
  sources:
  - repoURL: https://charts.jetstack.io
    chart: cert-manager
    targetRevision: v1.16.1
    helm:
      releaseName: cert-manager
      valueFiles:
      - $values/v0.2.0/platform/charts/cert-manager/values.yaml
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    ref: values
  destinationNamespaceOverwrite: cert-manager
  syncOptions:
  - ServerSideApply=true

- name: external-dns
  annotations:
    argocd.argoproj.io/sync-wave: "-10"
  sources:
  - repoURL: https://kubernetes-sigs.github.io/external-dns/
    chart: external-dns
    targetRevision: 1.15.0
    helm:
      releaseName: external-dns
      valueFiles:
      - $values/v0.2.0/platform/charts/external-dns/values.yaml
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    ref: values
  destinationNamespaceOverwrite: external-dns

# ArgoCD Self-Management
- name: argocd-self
  annotations:
    argocd.argoproj.io/sync-wave: "0"
  sources:
  - repoURL: https://argoproj.github.io/argo-helm
    chart: argo-cd
    targetRevision: 8.6.3
    helm:
      releaseName: argocd
      valueFiles:
      - $values/v0.2.0/platform/charts/argocd-self/values.yaml
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    ref: values
  destinationNamespaceOverwrite: argocd
  syncOptions:
  - Replace=false
  - ApplyOutOfSyncOnly=true
  ignoreDifferences:
  - group: argoproj.io
    kind: Application
    jqPathExpressions:
    - .status
    - .operation

# Configuration Applications (deployed after main charts)
- name: metallb-config
  annotations:
    argocd.argoproj.io/sync-wave: "10"
  sources:
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    path: v0.2.0/platform/apps/metallb-config
  destinationNamespaceOverwrite: metallb-system
- name: ingress-nginx-config
  annotations:
    argocd.argoproj.io/sync-wave: "20"
  sources:
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    path: v0.2.0/platform/apps/ingress-nginx-config
  destinationNamespaceOverwrite: ingress-nginx

- name: cert-manager-config
  annotations:
    argocd.argoproj.io/sync-wave: "30"
  sources:
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    path: v0.2.0/platform/apps/cert-manager-config
  destinationNamespaceOverwrite: cert-manager

- name: external-dns-config
  annotations:
    argocd.argoproj.io/sync-wave: "40"
  sources:
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    path: v0.2.0/platform/apps/external-dns-config
  destinationNamespaceOverwrite: external-dns

- name: argocd-config
  annotations:
    argocd.argoproj.io/sync-wave: "50"
  sources:
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    path: v0.2.0/platform/apps/argocd-config
  destinationNamespaceOverwrite: argocd

# Storage Foundation
- name: rook-ceph
  annotations:
    argocd.argoproj.io/sync-wave: "100"
  sources:
  - repoURL: https://charts.rook.io/release
    chart: rook-ceph
    targetRevision: v1.18.4
    helm:
      releaseName: rook-ceph
      valueFiles:
      - $values/v0.2.0/platform/charts/rook-ceph/values.yaml
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    ref: values
  destinationNamespaceOverwrite: rook-ceph
  syncOptions:
  - ServerSideApply=true
  - Replace=true

- name: rook-ceph-cluster
  annotations:
    argocd.argoproj.io/sync-wave: "200"
  sources:
  - repoURL: https://charts.rook.io/release
    chart: rook-ceph-cluster
    targetRevision: v1.18.4
    helm:
      releaseName: rook-ceph-cluster
      parameters:
      - name: operatorNamespace
        value: rook-ceph
      valueFiles:
      - $values/v0.2.0/platform/charts/rook-ceph-cluster/values.yaml
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    path: v0.2.0/platform/charts/rook-ceph-cluster/multisite
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    ref: values
  destinationNamespaceOverwrite: rook-ceph
  ignoreDifferences:
  - group: ceph.rook.io
    kind: CephCluster
    jqPathExpressions:
    - .status
    - .spec.cephVersion.image
    - .spec.placement
  - group: ceph.rook.io
    kind: CephBlockPool
    jqPathExpressions:
    - .status
  - group: ceph.rook.io
    kind: CephFilesystem
    jqPathExpressions:
    - .status
  - group: ceph.rook.io
    kind: CephObjectStore
    jqPathExpressions:
    - .status
  - group: storage.k8s.io
    kind: StorageClass
    jqPathExpressions:
    - .parameters

- name: zalando-pg
  annotations:
    argocd.argoproj.io/sync-wave: "300"
  sources:
  - repoURL: https://opensource.zalando.com/postgres-operator/charts/postgres-operator
    chart: postgres-operator
    targetRevision: v1.14.0
    helm:
      releaseName: zalando-pg
      valueFiles:
      - $values/v0.2.0/platform/charts/zalando-pg/values.yaml
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    ref: values
  destinationNamespaceOverwrite: postgres-operator
  syncOptions:
  - ServerSideApply=true
  - Replace=true
  ignoreDifferences:
  - group: apps
    kind: Deployment
    jqPathExpressions:
    - .status
    - .spec.template.spec.containers[0].image
  - group: apps
    kind: StatefulSet
    jqPathExpressions:
    - .status
    - .spec.template.spec.containers[0].image
  - group: apps
    kind: ReplicaSet
    jqPathExpressions:
    - .status
    - .spec.template.spec.containers[0].image

- name: postgres-operator-config
  annotations:
    argocd.argoproj.io/sync-wave: "310"
  sources:
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    path: v0.2.0/platform/apps/postgres-operator-config
  destinationNamespaceOverwrite: postgres-operator

- name: platform-db
  annotations:
    argocd.argoproj.io/sync-wave: "320"
  sources:
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    path: v0.2.0/platform/databases/platform
  destinationNamespaceOverwrite: platform-db-pg
  syncOptions:
  - CreateNamespace=true
- name: redis-operator
  annotations:
    argocd.argoproj.io/sync-wave: "330"
  sources:
  - repoURL: https://ot-container-kit.github.io/helm-charts/
    chart: redis-operator
    targetRevision: "v0.22.2"
    helm:
      releaseName: ot-helm
      valueFiles:
      - $values/v0.2.0/platform/charts/redis-operator/values.yaml
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    ref: values
  destinationNamespaceOverwrite: redis-operator
  syncOptions:
  - CreateNamespace=true
  - ServerSideApply=true

- name: platform-kv
  annotations:
    argocd.argoproj.io/sync-wave: "340"
  sources:
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    path: v0.2.0/platform/redis/platform-kv/cluster
  destinationNamespaceOverwrite: platform-kv-redis-cluster
  syncOptions:
  - CreateNamespace=true

# Security Platform
- name: sealed-secrets
  annotations:
    argocd.argoproj.io/sync-wave: "350"
  sources:
  - repoURL: https://charts.bitnami.com/bitnami
    chart: sealed-secrets
    targetRevision: 2.5.19
    helm:
      releaseName: sealed-secrets
      valueFiles:
      - $values/v0.2.0/platform/charts/sealed-secrets/values.yaml
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    ref: values
  destinationNamespaceOverwrite: sealed-secrets

- name: external-secrets
  annotations:
    argocd.argoproj.io/sync-wave: "350"
  destinationNamespaceOverwrite: external-secrets
  syncOptions:
  - ServerSideApply=true

- name: crossplane
  annotations:
    argocd.argoproj.io/sync-wave: "350"
  destinationNamespaceOverwrite: crossplane

# - name: vault
#   annotations:
#     argocd.argoproj.io/sync-wave: "360"
#   destinationNamespaceOverwrite: vault
#   syncOptions:
#   - ServerSideApply=true
#   - CreateNamespace=true

# # Monitoring Platform (commented out for initial deployment)
# - name: prometheus
#   annotations:
#     argocd.argoproj.io/sync-wave: "4"
#   sources:
#     - repoURL: https://prometheus-community.github.io/helm-charts
#       chart: kube-prometheus-stack
#       targetRevision: "65.1.1"
#       helm:
#         releaseName: prometheus
#         valueFiles:
#           - $values/v0.2.0/platform/charts/prometheus/values.yaml
#     - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
#       targetRevision: main
#       ref: values
#   destinationNamespaceOverwrite: monitoring

# - name: grafana
#   annotations:
#     argocd.argoproj.io/sync-wave: "5"
#   sources:
#     - repoURL: https://grafana.github.io/helm-charts
#       chart: grafana
#       targetRevision: "8.5.2"
#       helm:
#         releaseName: grafana
#         valueFiles:
#           - $values/v0.2.0/platform/charts/grafana/values.yaml
#     - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
#       targetRevision: main
#       ref: values
#   destinationNamespaceOverwrite: monitoring
