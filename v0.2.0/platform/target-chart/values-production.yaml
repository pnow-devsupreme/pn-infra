# Production Environment - Full Platform Stack
# KubriX-style configuration with clean, simple structure

# Default repository configuration
default:
  repoURL: 'https://github.com/pnow-devsupreme/pn-infra.git'
  targetRevision: 'main'

# Global configuration
global:
  automated:
    prune: true
    selfHeal: true
  retry:
    limit: 3
    backoff:
      duration: 5s
      factor: 2
      maxDuration: 3m

# Platform applications with sync wave ordering
applications:
# Infrastructure Foundation (negative waves deploy first)

- name: ingress-nginx
  annotations:
    argocd.argoproj.io/sync-wave: "-3"
  sources:
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    path: v0.2.0/platform/charts/ingress-nginx
  destinationNamespaceOverwrite: ingress-nginx

- name: cert-manager
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
  sources:
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    path: v0.2.0/platform/charts/cert-manager
  destinationNamespaceOverwrite: cert-manager
  syncOptions:
  - ServerSideApply=true

- name: external-dns
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
  sources:
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    path: v0.2.0/platform/charts/external-dns
  destinationNamespaceOverwrite: external-dns

# ArgoCD Self-Management
- name: argocd-self
  annotations:
    argocd.argoproj.io/sync-wave: "0"
  sources:
  - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
    targetRevision: main
    path: v0.2.0/platform/charts/argocd-self
  destinationNamespaceOverwrite: argocd
  syncOptions:
  - Replace=false
  - ApplyOutOfSyncOnly=true
  ignoreDifferences:
  - group: argoproj.io
    kind: Application
    jqPathExpressions:
    - .status
    - .operation

# Storage Foundation
# - name: rook-ceph
#   annotations:
#     argocd.argoproj.io/sync-wave: "1"
#   sources:
#     - repoURL: https://charts.rook.io/release
#       chart: rook-ceph
#       targetRevision: "v1.18.3"
#       helm:
#         releaseName: rook-ceph
#         valueFiles:
#           - $values/v0.2.0/platform/charts/rook-ceph/values.yaml
#     - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
#       targetRevision: main
#       ref: values
#   destinationNamespaceOverwrite: rook-ceph

# - name: rook-ceph-cluster
#   annotations:
#     argocd.argoproj.io/sync-wave: "2"
#   sources:
#     - repoURL: https://charts.rook.io/release
#       chart: rook-ceph-cluster
#       targetRevision: "v1.18.3"
#       helm:
#         releaseName: rook-ceph-cluster
#         parameters:
#           - name: operatorNamespace
#             value: rook-ceph
#         valueFiles:
#           - $values/v0.2.0/platform/charts/rook-ceph-cluster/values.yaml
#     - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
#       targetRevision: main
#       ref: values
#   destinationNamespaceOverwrite: rook-ceph
#   ignoreDifferences:
#     - group: ceph.rook.io
#       kind: CephCluster
#       jsonPointers:
#         - /status

# # Security Platform (commented out for initial deployment)
# - name: vault
#   annotations:
#     argocd.argoproj.io/sync-wave: "3"
#   sources:
#     - repoURL: https://helm.releases.hashicorp.com
#       chart: vault
#       targetRevision: "0.25.0"
#       helm:
#         releaseName: vault
#         valueFiles:
#           - $values/v0.2.0/platform/charts/vault/values.yaml
#     - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
#       targetRevision: main
#       ref: values
#   destinationNamespaceOverwrite: vault

# # Monitoring Platform (commented out for initial deployment)
# - name: prometheus
#   annotations:
#     argocd.argoproj.io/sync-wave: "4"
#   sources:
#     - repoURL: https://prometheus-community.github.io/helm-charts
#       chart: kube-prometheus-stack
#       targetRevision: "65.1.1"
#       helm:
#         releaseName: prometheus
#         valueFiles:
#           - $values/v0.2.0/platform/charts/prometheus/values.yaml
#     - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
#       targetRevision: main
#       ref: values
#   destinationNamespaceOverwrite: monitoring

# - name: grafana
#   annotations:
#     argocd.argoproj.io/sync-wave: "5"
#   sources:
#     - repoURL: https://grafana.github.io/helm-charts
#       chart: grafana
#       targetRevision: "8.5.2"
#       helm:
#         releaseName: grafana
#         valueFiles:
#           - $values/v0.2.0/platform/charts/grafana/values.yaml
#     - repoURL: https://github.com/pnow-devsupreme/pn-infra.git
#       targetRevision: main
#       ref: values
#   destinationNamespaceOverwrite: monitoring
