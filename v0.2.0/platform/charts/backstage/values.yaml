---
# Backstage Developer Portal Configuration for PN Platform

global:
  imageRegistry: ""

backstage:
  # Image settings
  image:
    registry: ghcr.io
    repository: backstage/backstage
    tag: latest
    pullPolicy: IfNotPresent
    pullSecrets: []

  # Deployment settings
  replicas: 2

  # Resources
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi

  # Environment variables from Secrets (CORRECTED - as array of secret names)
  extraEnvVarsSecrets:
  - backstage-secrets

  # Environment variables (if you need to specify individual env vars, use extraEnvVars)
  extraEnvVars:
  - name: KEYCLOAK_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: backstage-secrets
        key: keycloak-client-secret
  - name: GITHUB_TOKEN
    valueFrom:
      secretKeyRef:
        name: backstage-secrets
        key: github-token

  # Backstage app configuration
  appConfig:
    app:
      title: PN Platform Portal
      baseUrl: https://backstage.pnats.cloud

    organization:
      name: ProficientNow Technologies

    backend:
      baseUrl: https://backstage.pnats.cloud
      listen:
        port: 7007
        host: 0.0.0.0
      cors:
        origin: https://backstage.pnats.cloud
        methods: [ GET, HEAD, PATCH, POST, PUT, DELETE ]
        credentials: true
      database:
        client: better-sqlite3
        connection: ':memory:'
      csp:
        connect-src: [ "'self'", 'http:', 'https:' ]
      reading:
        allow:
        - host: github.com
        - host: '*.github.com'

    auth:
      environment: production
      providers:
        oidc:
          production:
            metadataUrl: https://keycloak.pnats.cloud/realms/platform/.well-known/openid-configuration
            clientId: backstage
            clientSecret: ${KEYCLOAK_CLIENT_SECRET}
            prompt: auto
            signIn:
              resolvers:
              - resolver: preferredUsernameMatchingUserEntityName

    catalog:
      import:
        entityFilename: catalog-info.yaml
        pullRequestBranchName: backstage-integration
      rules:
      - allow: [ Component, System, API, Resource, Location, Template ]
      locations:
      - type: url
        target: https://github.com/pnats-cloud/pn-infra/blob/main/backstage/templates/cluster-template.yaml
        rules:
        - allow: [ Template ]
      - type: url
        target: https://github.com/pnats-cloud/pn-infra/blob/main/backstage/templates/database-template.yaml
        rules:
        - allow: [ Template ]
      - type: url
        target: https://github.com/pnats-cloud/pn-infra/blob/main/backstage/catalog/infrastructure.yaml
        rules:
        - allow: [ Resource ]

    integrations:
      github:
      - host: github.com
        token: ${GITHUB_TOKEN}

    scaffolder:
      defaultAuthor:
        name: Backstage
        email: backstage@pnats.cloud

    kubernetes:
      serviceLocatorMethod:
        type: multiTenant
      clusterLocatorMethods:
      - type: config
        clusters:
        - name: primary
          url: https://kubernetes.default.svc
          authProvider: serviceAccount
          skipTLSVerify: false
          skipMetricsLookup: true

    techdocs:
      builder: local
      generator:
        runIn: local
      publisher:
        type: local

  # Container configuration
  containerPorts:
    backend: 7007

  # Probes
  readinessProbe:
    httpGet:
      path: /.backstage/health/v1/readiness
      port: 7007
      scheme: HTTP
  livenessProbe:
    httpGet:
      path: /.backstage/health/v1/liveness
      port: 7007
      scheme: HTTP

# Ingress
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-production
    external-dns.alpha.kubernetes.io/ttl: "60"
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
  host: backstage.pnats.cloud
  path: "/"
  tls:
    enabled: true
    secretName: backstage-tls

# Service
service:
  type: ClusterIP
  ports:
    backend: 7007
    name: http-backend
    targetPort: backend

# Service account
serviceAccount:
  create: true
  automountServiceAccountToken: true

# PostgreSQL
postgresql:
  enabled: false

# Network policy
networkPolicy:
  enabled: false

# Metrics
metrics:
  serviceMonitor:
    enabled: false
