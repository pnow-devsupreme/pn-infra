---
apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-cert-sync
  namespace: infisical
  annotations:
    # Run on every sync to refresh certificate
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
    argocd.argoproj.io/sync-wave: "-1"
spec:
  template:
    spec:
      serviceAccountName: cert-sync-job
      restartPolicy: OnFailure
      containers:
      - name: cert-sync
        image: alpine/k8s:1.32.8
        command:
        - /bin/sh
        - -c
        - |
          set -e

          echo "Extracting PostgreSQL certificate from platform-db-cluster-0..."

          # Extract certificate from PostgreSQL pod (PEM format)
          CERT_PEM=$(kubectl exec platform-db-cluster-0 -n platform-db-pg -c postgres -- cat /run/certs/server.crt)

          if [ -z "$CERT_PEM" ]; then
            echo "ERROR: Failed to extract certificate"
            exit 1
          fi

          echo "Certificate extracted successfully"

          # Update ConfigMap with certificate file
          echo "Updating ConfigMap postgres-ca-cert..."
          kubectl create configmap postgres-ca-cert -n infisical \
            --from-literal=ca.crt="$CERT_PEM" \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "Certificate synced to ConfigMap successfully!"
