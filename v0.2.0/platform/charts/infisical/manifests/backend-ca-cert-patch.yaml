---
# Patch to add PostgreSQL CA certificate volume mount to Infisical backend
# This enables NODE_EXTRA_CA_CERTS to trust the self-signed PostgreSQL certificate
# See: https://infisical.com/docs/self-hosting/guides/custom-certificates
apiVersion: apps/v1
kind: Deployment
metadata:
  name: infisical-backend
  namespace: infisical
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  template:
    spec:
      containers:
      - name: backend
        env:
        # Add NODE_EXTRA_CA_CERTS to trust custom CA certificate
        - name: NODE_EXTRA_CA_CERTS
          value: /usr/local/share/ca-certificates/ca.crt
        volumeMounts:
        # Mount PostgreSQL CA certificate
        - name: postgres-ca-cert
          mountPath: /usr/local/share/ca-certificates
          readOnly: true
      volumes:
      # PostgreSQL CA certificate from ConfigMap
      - name: postgres-ca-cert
        configMap:
          name: postgres-ca-cert
          items:
          - key: ca.crt
            path: ca.crt
