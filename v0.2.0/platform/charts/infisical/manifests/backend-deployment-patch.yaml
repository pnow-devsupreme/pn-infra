---
# Strategic Merge Patch for Infisical Backend Deployment
# Adds PostgreSQL CA certificate volume mount and NODE_EXTRA_CA_CERTS environment variable
# This enables the backend to trust the self-signed PostgreSQL certificate
# See: https://infisical.com/docs/self-hosting/guides/custom-certificates
#
# Deployment order (controlled by sync-wave):
# 1. sync-wave: -2 → ConfigMap placeholder and RBAC created
# 2. sync-wave: -1 → cert-sync PreSync job runs and populates ConfigMap
# 3. sync-wave:  0 → Backend deployment applies with volume mount
apiVersion: apps/v1
kind: Deployment
metadata:
  name: infisical-backend
  namespace: infisical
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  template:
    spec:
      containers:
      - name: infisical-backend
        env:
        - name: NODE_EXTRA_CA_CERTS
          value: /usr/local/share/ca-certificates/ca.crt
        volumeMounts:
        - name: postgres-ca-cert
          mountPath: /usr/local/share/ca-certificates
          readOnly: true
      volumes:
      - name: postgres-ca-cert
        configMap:
          name: postgres-ca-cert
          items:
          - key: ca.crt
            path: ca.crt
