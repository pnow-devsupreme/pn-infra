---
# Global configuration
global:
  repoURL: 'https://github.com/pnow-devsupreme/pn-infra.git'
  targetRevision: 'main'

# Labels configuration
labels:
  component: zolando-pg-operator
  component-category: database
  db-type: relational-db
  db-type-name: postgres
  managed-by: argocd

# Zalando Postgres Operator Configuration
# Based on: https://github.com/zalando/postgres-operator
postgres-operator:
  enabled: true

  # Operator image
  image:
    repository: registry.opensource.zalan.do/acid/postgres-operator
    tag: v1.14.0
    pullPolicy: IfNotPresent

  # AWS/GCP Configuration
  configAwsOrGcp:
    aws_region: ap-south-2
    enable_ebs_gp3_migration: false

  # Kubernetes Configuration
  configKubernetes:
    cluster_domain: cluster.local
    storage_resize_mode: pvc
    pod_terminate_grace_period: 5m
    watched_namespace: "*"
    # Pod environment variables for WAL-G (PITR)
    pod_environment_configmap: postgres-operator/postgres-backup-config
    pod_environment_secret: postgres-operator/postgres-backup-credentials
    enable_pod_antiaffinity: false
    enable_persistent_volume_claim_deletion: true
    enable_secrets_deletion: true

  # Connection Pooler Configuration
  configConnectionPooler:
    connection_pooler_number_of_instances: 2
    connection_pooler_mode: transaction
    connection_pooler_default_cpu_request: 500m
    connection_pooler_default_cpu_limit: "1"
    connection_pooler_default_memory_request: 100Mi
    connection_pooler_default_memory_limit: 100Mi

  # Load Balancer Configuration
  configLoadBalancer:
    enable_master_load_balancer: false
    enable_replica_load_balancer: false

  # PostgreSQL Pod Resources
  configPostgresPodResources:
    default_cpu_request: 100m
    default_memory_request: 100Mi
    default_cpu_limit: "1"
    default_memory_limit: 500Mi
    min_cpu_limit: 250m
    min_memory_limit: 250Mi

  # Logical Backup Configuration (Snapshots)
  configLogicalBackup:
    logical_backup_docker_image: "ghcr.io/zalando/postgres-operator/logical-backup:v1.13.0"
    logical_backup_provider: "s3"
    logical_backup_schedule: "0 2 * * *"  # Daily at 2 AM
    logical_backup_s3_bucket: "pn-platform-db-backups"
    logical_backup_s3_region: "ap-south-2"
    logical_backup_s3_endpoint: ""  # Use default AWS S3 endpoint
    logical_backup_s3_bucket_prefix: "spilo"
    logical_backup_s3_sse: "AES256"
    logical_backup_s3_access_key_id: ""  # Will use pod_environment_secret
    logical_backup_s3_secret_access_key: ""  # Will use pod_environment_secret
    logical_backup_cronjob_environment_secret: "postgres-backup-credentials"

  # General Configuration
  configGeneral:
    enable_pgversion_env_var: true
    enable_shm_volume: true
    resync_period: 30m
    repair_period: 5m
    workers: 8
    docker_image: ghcr.io/zalando/spilo-17:4.0-p2

  # Debug Configuration
  configDebug:
    debug_logging: true
    enable_database_access: true

  # Resource limits for the operator itself
  resources:
    requests:
      memory: "64Mi"
      cpu: "50m"
    limits:
      memory: "128Mi"
      cpu: "200m"

  # Service account and RBAC
  serviceAccount:
    create: true
    name: postgres-operator

  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000


# CRDs - the operator will manage these
crds:
  enabled: true

# Service configuration
service:
  type: ClusterIP
  port: 8080

# Pod configuration
podLabels:
  app.kubernetes.io/component: database-operator
  app.kubernetes.io/part-of: platform

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8080"
