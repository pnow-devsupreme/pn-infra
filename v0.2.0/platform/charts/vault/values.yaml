---
# Vault Helm Chart Values
# Chart: https://helm.releases.hashicorp.com
# Version: 0.25.0

global:
  enabled: true
  tlsDisable: true

injector:
  enabled: false

server:
  enabled: true

  # Image configuration
  image:
    repository: "hashicorp/vault"
    tag: "1.20.3"
    pullPolicy: IfNotPresent

  # Resources
  resources:
    requests:
      memory: 256Mi
      cpu: 250m
    limits:
      memory: 512Mi
      cpu: 500m

  # Readiness probe
  readinessProbe:
    enabled: true
    path: "/v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204"

  # Liveness probe
  livenessProbe:
    enabled: true
    path: "/v1/sys/health?standbyok=true"
    initialDelaySeconds: 60

  # Audit storage
  auditStorage:
    enabled: true
    size: 10Gi
    storageClass: ceph-block

  # Data storage
  dataStorage:
    enabled: true
    size: 10Gi
    storageClass: ceph-block

  # Environment variables
  extraEnvironmentVars:
    VAULT_ADDR: "http://127.0.0.1:8200"

  # Init containers to download utilities
  extraInitContainers:
    - name: utility-downloader
      image: alpine/curl:latest
      command:
        - /bin/sh
        - -c
        - |
          cd /usr/local/libexec/vault
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          curl -L -o jq https://github.com/stedolan/jq/releases/download/jq-1.8.1/jq-linux64
          chmod +x jq
      volumeMounts:
        - name: plugins
          mountPath: /usr/local/libexec/vault
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        privileged: false
        runAsNonRoot: true

  # Sidecar containers for auto-initialization and auto-unsealing
  extraContainers:
    # Auto-initializer: Initializes Vault and stores keys in Kubernetes secret
    - name: auto-initializer
      image: hashicorp/vault:1.20.3
      env:
        - name: VAULT_ADDR
          value: "http://127.0.0.1:8200"
      command:
        - /bin/sh
        - -c
        - |
          while true; do
            sleep 10
            while [ -z $UNSEAL_KEY ]; do
              sleep 5
              VAULT_STATUS=$(vault status)
              if echo "$VAULT_STATUS" | grep -q "Initialized.*false" && [ $HOSTNAME = 'vault-0' ]; then
                export INIT_RESPONSE=$(vault operator init -format=json -key-shares=1 -key-threshold=1)
                echo "$INIT_RESPONSE"
                export UNSEAL_KEY=$(echo "$INIT_RESPONSE" | /usr/local/libexec/vault/jq -r .unseal_keys_b64[0])
                export ROOT_TOKEN=$(echo "$INIT_RESPONSE" | /usr/local/libexec/vault/jq -r .root_token)
                echo "$UNSEAL_KEY"
                echo "$ROOT_TOKEN"
                /usr/local/libexec/vault/kubectl delete secret vault-init -n vault --ignore-not-found=true
                /usr/local/libexec/vault/kubectl create secret generic vault-init -n vault --from-literal=unseal_key=${UNSEAL_KEY} --from-literal=root_token=${ROOT_TOKEN}
              else
                echo "Vault already initialized or not vault-0"
              fi
            done
          done
      volumeMounts:
        - name: plugins
          mountPath: /usr/local/libexec/vault
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        privileged: false
        runAsNonRoot: true

    # Auto-unsealer: Automatically unseals Vault using the stored key
    - name: auto-unsealer
      image: hashicorp/vault:1.20.3
      env:
        - name: VAULT_ADDR
          value: "http://127.0.0.1:8200"
      command:
        - /bin/sh
        - -c
        - |
          while true; do
            sleep 10
            VAULT_STATUS=$(vault status)
            if echo "$VAULT_STATUS" | grep -q "Initialized.*false" && [ $HOSTNAME != 'vault-0' ]; then
              echo "Joining raft cluster"
              vault operator raft join http://vault-0.vault-internal:8200
              sleep 5
            fi
            if echo "$VAULT_STATUS" | grep -q "Initialized.*true"; then
              if echo "$VAULT_STATUS" | grep -q "Sealed.*true"; then
                if [ -f /vault-root-token/unseal_key ]; then
                  vault operator unseal $(cat /vault-root-token/unseal_key)
                  sleep 5
                else
                  echo "Unseal key not initialized yet"
                fi
              else
                echo "Vault already unsealed"
              fi
            else
              echo "Vault not initialized yet"
            fi
          done
      volumeMounts:
        - name: vault-root-token
          mountPath: /vault-root-token
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        privileged: false
        runAsNonRoot: true

  # High Availability with Raft integrated storage
  ha:
    enabled: true
    replicas: 3

    raft:
      enabled: true
      setNodeId: true

      config: |
        ui = true

        listener "tcp" {
          tls_disable = 1
          address = "[::]:8200"
          cluster_address = "[::]:8201"
          telemetry {
            unauthenticated_metrics_access = "true"
          }
        }

        storage "raft" {
          path = "/vault/data"
        }

        disable_mlock = true

        telemetry {
          prometheus_retention_time = "30m"
          disable_hostname = true
        }

        service_registration "kubernetes" {}
        plugin_directory = "/usr/local/libexec/vault"

  # Volumes
  volumes:
    - name: plugins
      emptyDir: {}
    - name: vault-root-token
      secret:
        secretName: vault-init
        optional: true

  # Volume mounts
  volumeMounts:
    - mountPath: /usr/local/libexec/vault
      name: plugins
      readOnly: false

  # Service configuration
  service:
    enabled: true
    type: ClusterIP
    port: 8200
    targetPort: 8200

  # Ingress
  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-production
      nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    hosts:
      - host: vault.pnats.cloud
        paths:
          - /
    tls:
      - secretName: vault-tls
        hosts:
          - vault.pnats.cloud

  # Service account
  serviceAccount:
    create: true
    name: vault

# UI
ui:
  enabled: true
  serviceType: ClusterIP
