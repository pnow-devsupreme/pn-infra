---
# Vault Helm Chart Values
# Chart: https://helm.releases.hashicorp.com
# Version: 0.25.0

global:
  enabled: true
  tlsDisable: false

injector:
  enabled: false

server:
  enabled: true

  # Image configuration
  image:
    repository: "hashicorp/vault"
    tag: "1.15.6"
    pullPolicy: IfNotPresent

  # Resources
  resources:
    requests:
      memory: 256Mi
      cpu: 250m
    limits:
      memory: 512Mi
      cpu: 500m

  # Readiness probe
  readinessProbe:
    enabled: true
    path: "/v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204"

  # Liveness probe
  livenessProbe:
    enabled: true
    path: "/v1/sys/health?standbyok=true"
    initialDelaySeconds: 60

  # Audit storage
  auditStorage:
    enabled: true
    size: 10Gi
    storageClass: ceph-block

  # Data storage
  dataStorage:
    enabled: true
    size: 10Gi
    storageClass: ceph-block

  # High Availability with Raft integrated storage
  ha:
    enabled: true
    replicas: 3

    raft:
      enabled: true
      setNodeId: true

      config: |
        ui = true

        listener "tcp" {
          tls_disable = 1
          address = "[::]:8200"
          cluster_address = "[::]:8201"
        }

        storage "raft" {
          path = "/vault/data"

          retry_join {
            leader_api_addr = "http://vault-0.vault-internal:8200"
          }

          retry_join {
            leader_api_addr = "http://vault-1.vault-internal:8200"
          }

          retry_join {
            leader_api_addr = "http://vault-2.vault-internal:8200"
          }
        }

        service_registration "kubernetes" {}

  # Service configuration
  service:
    enabled: true
    type: ClusterIP
    port: 8200
    targetPort: 8200

  # Ingress
  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-production
      nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    hosts:
      - host: vault.pnats.cloud
        paths:
          - /
    tls:
      - secretName: vault-tls
        hosts:
          - vault.pnats.cloud

  # Service account
  serviceAccount:
    create: true
    name: vault

# UI
ui:
  enabled: true
  serviceType: ClusterIP
