---
# Temporal HA Deployment with PostgreSQL

# Chart dependency - using upstream Temporal chart
temporal:
  # Server configuration
  server:
    enabled: true
    image:
      repository: temporalio/server
      tag: "1.24.2" # Consider updating to 1.29.1 for latest features
      pullPolicy: IfNotPresent

    # IMMUTABLE: Do not change after initial deployment
    config:
      # IMPORTANT: This must be at the config level, not server level
      numHistoryShards: 512

      # Database configuration - PostgreSQL
      persistence:
        default:
          driver: "sql"
          sql:
            driver: "postgres12"
            host: "temporal-postgres"
            port: 5432
            database: "temporal"
            user: "temporal"
            existingSecret: "postgres.temporal-postgres.credentials.postgresql.acid.zalan.do"
            maxConns: 20
            maxIdleConns: 20
            maxConnLifetime: "1h"
        visibility:
          driver: "sql"
          sql:
            driver: "postgres12"
            host: "temporal-postgres"
            port: 5432
            database: "temporal_visibility"
            user: "temporal"
            existingSecret: "postgres.temporal-postgres.credentials.postgresql.acid.zalan.do"
            maxConns: 20
            maxIdleConns: 20
            maxConnLifetime: "1h"
      # Namespace configuration - FIXED
      namespaces:
        create: true
        namespace:
        - name: "default"
          retention: "72h" # 3 days in hours
        - name: "pnats"
          retention: "2160h" # 90 days in hours
        - name: "pnats-staging"
          retention: "1440h" # 60 days in hours
        - name: "pnats-dev"
          retention: "720h" # 30 days in hours

      # Logging
      logLevel: "info,warn"

    # Replica configuration for HA
    replicaCount: 3 # This is for the server container, individual services have their own replicas

    # Service configuration
    frontend:
      service:
        type: LoadBalancer
        port: 7233
        annotations:
          external-dns.alpha.kubernetes.io/hostname: temporal.pnats.cloud
          external-dns.alpha.kubernetes.io/ttl: "60"
          metallb.universe.tf/ip-allocated-from-pool: public-pool

      # Add ingress for frontend service
      ingress:
        enabled: false
        className: "nginx"
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-production
          external-dns.alpha.kubernetes.io/ttl: "60"
          nginx.ingress.kubernetes.io/backend-protocol: "GRPC"
          nginx.ingress.kubernetes.io/grpc-backend: "true"
        hosts:
        - temporal-api.pnats.cloud
        tls:
        - secretName: temporal-api-tls
          hosts:
          - temporal-api.pnats.cloud

    # Resource allocation per pod
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 2000m
        memory: 2Gi

    # Metrics configuration
    metrics:
      annotations:
        enabled: true
      serviceMonitor:
        enabled: true
        interval: 30s
      prometheus:
        timerType: histogram

  # Individual service replicas for HA
  frontend:
    replicaCount: 3
    metrics:
      serviceMonitor:
        enabled: true
        interval: 30s
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi

  history:
    replicaCount: 3
    metrics:
      serviceMonitor:
        enabled: true
        interval: 30s
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 4Gi

  matching:
    replicaCount: 3
    metrics:
      serviceMonitor:
        enabled: true
        interval: 30s
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi

  worker:
    replicaCount: 5
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi

  # Web UI
  web:
    enabled: true
    replicaCount: 2
    image:
      repository: temporalio/ui
      tag: "2.26.2"
      pullPolicy: IfNotPresent

    service:
      type: ClusterIP
      port: 8080
      annotations: {}

    ingress:
      enabled: true
      className: "nginx"
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-production
        external-dns.alpha.kubernetes.io/ttl: "60"
      hosts:
      - "temporal-ui.pnats.cloud"
      tls:
      - secretName: temporal-ui-tls
        hosts:
        - temporal-ui.pnats.cloud

    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

    # Web UI configuration to connect to Temporal cluster
    additionalEnv:
    - name: TEMPORAL_ADDRESS
      value: "temporal-frontend:7233"
    - name: TEMPORAL_CORS_ORIGINS
      value: "https://temporal-ui.pnats.cloud"

  # Admin tools
  admintools:
    enabled: true
    image:
      repository: temporalio/admin-tools
      tag: "1.24.2-tctl-1.18.0" # Use specific version matching your server
      pullPolicy: IfNotPresent
    service:
      type: ClusterIP
      port: 22

  # Schema setup and updates
  schema:
    setup:
      enabled: true
      backoffLimit: 100
    update:
      enabled: true
      backoffLimit: 100

  # PostgreSQL - Using Zalando postgres-operator cluster
  postgresql:
    enabled: false

  # Disable Cassandra (using PostgreSQL)
  cassandra:
    enabled: false

  # Disable MySQL
  mysql:
    enabled: false

  # Disable Elasticsearch (using PostgreSQL for visibility)
  elasticsearch:
    enabled: false

  # Use cluster Prometheus
  prometheus:
    enabled: false

  # Grafana dashboards only (using cluster Grafana instance)
  grafana:
    enabled: true
    replicas: 0 # Don't deploy Grafana pods, just create dashboard ConfigMaps
    testFramework:
      enabled: false
    rbac:
      create: false
      pspEnabled: false
      namespaced: true
    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
        - name: "temporal"
          orgId: 1
          folder: "Temporal"
          type: file
          disableDeletion: true
          editable: true
          options:
            path: /var/lib/grafana/dashboards/temporal
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
        - name: TemporalMetrics
          type: prometheus
          url: http://prometheus-kube-prometheus-prometheus.monitoring.svc:9090
          access: proxy
          isDefault: false
    dashboards:
      default:
        server-general-github:
          url: https://raw.githubusercontent.com/temporalio/dashboards/helm/server/server-general.json
          datasource: TemporalMetrics
        sdk-general-github:
          url: https://raw.githubusercontent.com/temporalio/dashboards/helm/sdk/sdk-general.json
          datasource: TemporalMetrics
        misc-advanced-visibility-specific-github:
          url: https://raw.githubusercontent.com/temporalio/dashboards/helm/misc/advanced-visibility-specific.json
          datasource: TemporalMetrics
        misc-clustermonitoring-kubernetes-github:
          url: https://raw.githubusercontent.com/temporalio/dashboards/helm/misc/clustermonitoring-kubernetes.json
          datasource: TemporalMetrics
        misc-frontend-service-specific-github:
          url: https://raw.githubusercontent.com/temporalio/dashboards/helm/misc/frontend-service-specific.json
          datasource: TemporalMetrics
        misc-history-service-specific-github:
          url: https://raw.githubusercontent.com/temporalio/dashboards/helm/misc/history-service-specific.json
          datasource: TemporalMetrics
        misc-matching-service-specific-github:
          url: https://raw.githubusercontent.com/temporalio/dashboards/helm/misc/matching-service-specific.json
          datasource: TemporalMetrics
        misc-worker-service-specific-github:
          url: https://raw.githubusercontent.com/temporalio/dashboards/helm/misc/worker-service-specific.json
          datasource: TemporalMetrics
