---
# Custom NGINX Configuration
nginxConfig:
  enabled: true
  name: nginx-configuration

  ssl:
    protocols: TLSv1.2 TLSv1.3
    ciphers: ECDHE-RSA-AES128-GCM-SHA256,ECDHE-RSA-AES256-GCM-SHA384,ECDHE-RSA-AES128-SHA,ECDHE-RSA-AES256-SHA,ECDHE-RSA-AES128-SHA256,ECDHE-RSA-AES256-SHA384

  proxy:
    bodySize: 100m
    readTimeout: "300"
    sendTimeout: "300"
    connectTimeout: "300"

  gzip:
    enabled: "true"
    types: application/javascript,application/json,application/xml,text/css,text/javascript,text/plain,text/xml

  rateLimit:
    connections: "20"
    rateAfter: 1024k
    rate: 512k

# Custom Security Headers
customHeaders:
  enabled: true
  name: custom-headers

  headers:
    X-Frame-Options: DENY
    X-Content-Type-Options: nosniff
    X-XSS-Protection: "1; mode=block"
    Referrer-Policy: strict-origin-when-cross-origin
    Strict-Transport-Security: max-age=31536000; includeSubDomains
    Content-Security-Policy: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"

# Ingress-NGINX subchart configuration
ingress-nginx:
  controller:
    replicaCount: 3

    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

    service:
      type: LoadBalancer
      externalTrafficPolicy: Local

    autoscaling:
      enabled: true
      minReplicas: 2
      maxReplicas: 10
      targetCPUUtilizationPercentage: 70
      targetMemoryUtilizationPercentage: 80

    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
      prometheusRule:
        enabled: true
        rules:
          - alert: NGINXConfigFailed
            expr: count(nginx_ingress_controller_config_last_reload_successful == 0) > 0
            for: 1s
            labels:
              severity: critical
            annotations:
              description: bad ingress config - nginx config test failed
              summary: uninstall the latest ingress changes to allow config reloads to resume

          - alert: NGINXCertificateExpiry
            expr: (avg(nginx_ingress_controller_ssl_expire_time_seconds{host!="_"}) by (host) - time()) < 604800
            for: 1s
            labels:
              severity: critical
            annotations:
              description: ssl certificate(s) will expire in less then a week
              summary: renew expiring certificates to avoid downtime

          - alert: NGINXTooMany500s
            expr: 100 * ( sum( nginx_ingress_controller_requests{status=~"5.+"} ) / sum(nginx_ingress_controller_requests) ) > 5
            for: 1m
            labels:
              severity: warning
            annotations:
              description: Too many 5XXs
              summary: More than 5% of all requests returned 5XX, this requires your attention

          - alert: NGINXTooMany400s
            expr: 100 * ( sum( nginx_ingress_controller_requests{status=~"4.+"} ) / sum(nginx_ingress_controller_requests) ) > 5
            for: 1m
            labels:
              severity: warning
            annotations:
              description: Too many 4XXs
              summary: More than 5% of all requests returned 4XX, this requires your attention

    podDisruptionBudget:
      enabled: true
      minAvailable: 1

    allowSnippetAnnotations: true

    admissionWebhooks:
      enabled: true
      failurePolicy: Ignore

    config:
      allow-snippet-annotations: "true"
      proxy-set-headers: "ingress-nginx/custom-headers"
      ssl-protocols: "TLSv1.2 TLSv1.3"
      ssl-ciphers: "ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384"
      proxy-body-size: "100m"
      proxy-read-timeout: "300"
      proxy-send-timeout: "300"
      proxy-connect-timeout: "300"
      enable-gzip: "true"
      gzip-types: "application/javascript,application/json,application/xml,text/css,text/javascript,text/plain,text/xml"
      limit-connections: "20"
      limit-rate-after: "1024k"
      limit-rate: "512k"

  defaultBackend:
    enabled: true
    replicaCount: 2
    minAvailable: 1

    resources:
      requests:
        cpu: 10m
        memory: 20Mi
      limits:
        cpu: 50m
        memory: 64Mi

    autoscaling:
      enabled: true
      minReplicas: 2
      maxReplicas: 10
      targetCPUUtilizationPercentage: 70
      targetMemoryUtilizationPercentage: 80
