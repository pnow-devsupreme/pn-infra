---
# Master Orchestrator - Domain-Based Ansible Provisioning System
# Orchestrates 8 domain playbooks with dependency management and status tracking
#
# Dependency Chain:
# Foundation: Base â†’ Software
# System Layer: System Settings, Disk Management (depend on Software)
# Identity Layer: Identity & Users (depends on Base)
# Infrastructure Layer: Directories (depends on Identity), Networking (depends on Base)
# Security Layer: Security (depends on Base, Software, Identity, Networking)

- name: 'Domain-Based Provisioning System - Master Orchestrator'
  hosts: all
  gather_facts: true
  become: true
  vars:
      orchestration_start_time: '{{ ansible_date_time.iso8601 }}'
      total_playbooks: 8
      executed_playbooks: 0
      successful_playbooks: 0
      failed_playbooks: 0

  tasks:
      - name: Initialize orchestration tracking
        set_fact:
            orchestration_status:
                start_time: '{{ orchestration_start_time }}'
                hostname: '{{ ansible_hostname }}'
                total_playbooks: '{{ total_playbooks }}'
                executed: 0
                successful: 0
                failed: 0
                status_flags: {}
                execution_log: []

      - name: Log orchestration start
        debug:
            msg: |
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                Starting Domain-Based Ansible Provisioning System
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                Hostname: {{ ansible_hostname }}
                Start Time: {{ orchestration_start_time }}
                Total Playbooks: {{ total_playbooks }}
                Dependency Management: Enabled
                Safety Patterns: 5-phase (validateâ†’backupâ†’applyâ†’testâ†’rollback)
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# PHASE 1: FOUNDATION LAYER
# Base and Software roles provide foundational system configuration

- import_playbook: playbooks/base.yml
  vars:
      phase: 'Foundation'
      phase_description: 'Base system configuration (timezone, locale, time sync, logging)'

- import_playbook: playbooks/software.yml
  vars:
      phase: 'Foundation'
      phase_description: 'Software package management and repositories'

# PHASE 2: SYSTEM CONFIGURATION LAYER
# System settings and disk management can run in parallel after software is ready

- import_playbook: playbooks/system_settings.yml
  when: software_status is defined and software_status == "success"
  vars:
      phase: 'System Configuration'
      phase_description: 'Kernel modules, sysctl, systemd services, optimization'

- import_playbook: playbooks/disk_management.yml
  when: software_status is defined and software_status == "success"
  vars:
      phase: 'System Configuration'
      phase_description: 'Partitioning, filesystem creation, mounting, fstab'

# PHASE 3: IDENTITY & INFRASTRUCTURE LAYER
# Identity depends on base, then directories depend on identity
# Networking can run independently after base

- import_playbook: playbooks/identity_users.yml
  when: base_status is defined and base_status == "success"
  vars:
      phase: 'Identity & Infrastructure'
      phase_description: 'User management, SSH configuration, groups, permissions'

- import_playbook: playbooks/directories.yml
  when: identity_status is defined and identity_status == "success"
  vars:
      phase: 'Identity & Infrastructure'
      phase_description: 'Directory creation with cascade ownership and permissions'

- import_playbook: playbooks/networking.yml
  when: base_status is defined and base_status == "success"
  vars:
      phase: 'Identity & Infrastructure'
      phase_description: 'VLAN configuration and network interface management'

# PHASE 4: SECURITY LAYER
# Security hardening requires multiple prerequisite roles for comprehensive protection

- import_playbook: playbooks/security.yml
  when: >
      base_status is defined and base_status == "success" and
      software_status is defined and software_status == "success" and
      identity_status is defined and identity_status == "success" and
      networking_status is defined and networking_status == "success"
  vars:
      phase: 'Security'
      phase_description: 'System hardening, firewall, fail2ban, security policies'

# PHASE 5: ORCHESTRATION COMPLETION AND REPORTING

- name: 'Orchestration Completion and Status Reporting'
  hosts: all
  gather_facts: false
  become: true

  tasks:
      - name: Collect all playbook status flags
        set_fact:
            final_status_summary:
                base_status: "{{ base_status | default('not_executed') }}"
                software_status: "{{ software_status | default('not_executed') }}"
                system_settings_status: "{{ system_settings_status | default('not_executed') }}"
                disk_management_status: "{{ disk_management_status | default('not_executed') }}"
                identity_status: "{{ identity_status | default('not_executed') }}"
                directories_status: "{{ directories_status | default('not_executed') }}"
                networking_status: "{{ networking_status | default('not_executed') }}"
                security_status: "{{ security_status | default('not_executed') }}"

      - name: Calculate orchestration statistics
        set_fact:
            orchestration_stats:
                executed_count: >-
                    {{ [
                      base_status, software_status, system_settings_status, disk_management_status,
                      identity_status, directories_status, networking_status, security_status
                    ] | select('defined') | list | length }}
                successful_count: >-
                    {{ [
                      base_status, software_status, system_settings_status, disk_management_status,
                      identity_status, directories_status, networking_status, security_status
                    ] | select('defined') | select('equalto', 'success') | list | length }}
                failed_count: >-
                    {{ [
                      base_status, software_status, system_settings_status, disk_management_status,
                      identity_status, directories_status, networking_status, security_status
                    ] | select('defined') | select('equalto', 'failed') | list | length }}
                not_executed_count: >-
                    {{ [
                      base_status, software_status, system_settings_status, disk_management_status,
                      identity_status, directories_status, networking_status, security_status
                    ] | select('undefined') | list | length }}

      - name: Determine overall orchestration status
        set_fact:
            overall_orchestration_status: >-
                {% if orchestration_stats.failed_count | int > 0 %}failed
                {% elif orchestration_stats.successful_count | int == total_playbooks | int %}complete_success
                {% elif orchestration_stats.successful_count | int > 0 %}partial_success
                {% else %}no_execution
                {% endif %}

      - name: Create comprehensive orchestration status report
        copy:
            content: |
                # Domain-Based Ansible Provisioning System - Final Status Report
                # Generated: {{ ansible_date_time.iso8601 }}

                [ORCHESTRATION_SUMMARY]
                hostname: {{ ansible_hostname }}
                start_time: {{ orchestration_start_time }}
                completion_time: {{ ansible_date_time.iso8601 }}
                overall_status: {{ overall_orchestration_status }}

                [STATISTICS]
                total_playbooks: {{ total_playbooks }}
                executed_playbooks: {{ orchestration_stats.executed_count }}
                successful_playbooks: {{ orchestration_stats.successful_count }}
                failed_playbooks: {{ orchestration_stats.failed_count }}
                not_executed_playbooks: {{ orchestration_stats.not_executed_count }}
                success_rate: {{ ((orchestration_stats.successful_count | int / total_playbooks | int) * 100) | round(1) }}%

                [PLAYBOOK_STATUS_DETAILS]
                # Phase 1 - Foundation
                base: {{ final_status_summary.base_status }}
                software: {{ final_status_summary.software_status }}

                # Phase 2 - System Configuration  
                system_settings: {{ final_status_summary.system_settings_status }}
                disk_management: {{ final_status_summary.disk_management_status }}

                # Phase 3 - Identity & Infrastructure
                identity_users: {{ final_status_summary.identity_status }}
                directories: {{ final_status_summary.directories_status }}
                networking: {{ final_status_summary.networking_status }}

                # Phase 4 - Security
                security: {{ final_status_summary.security_status }}

                [DEPENDENCY_ANALYSIS]
                foundation_layer: {{ 'stable' if (final_status_summary.base_status == 'success' and final_status_summary.software_status == 'success') else 'unstable' }}
                system_layer: {{ 'stable' if (final_status_summary.system_settings_status in ['success', 'not_executed'] and final_status_summary.disk_management_status in ['success', 'not_executed']) else 'unstable' }}
                identity_layer: {{ 'stable' if final_status_summary.identity_status in ['success', 'not_executed'] else 'unstable' }}
                infrastructure_layer: {{ 'stable' if (final_status_summary.directories_status in ['success', 'not_executed'] and final_status_summary.networking_status in ['success', 'not_executed']) else 'unstable' }}
                security_layer: {{ 'stable' if final_status_summary.security_status in ['success', 'not_executed'] else 'unstable' }}

                [STATUS_FILES_CREATED]
                base_status_file: /var/lib/ansible/base-role-status
                software_status_file: /var/lib/ansible/software-role-status
                system_settings_status_file: /var/lib/ansible/system-settings-role-status
                disk_management_status_file: /var/lib/ansible/disk-management-role-status
                identity_status_file: /var/lib/ansible/identity-users-role-status
                directories_status_file: /var/lib/ansible/directories-role-status
                networking_status_file: /var/lib/ansible/networking-role-status
                security_status_file: /var/lib/ansible/security-role-status
                playbook_status_files: /var/lib/ansible/playbook-*-status

                [CRITICAL_WARNINGS]
                {% if final_status_summary.base_status == 'failed' %}
                - BASE ROLE FAILED: System foundation is unstable - manual intervention required
                {% endif %}
                {% if final_status_summary.software_status == 'failed' %}
                - SOFTWARE ROLE FAILED: Package management issues - dependent roles may fail
                {% endif %}
                {% if final_status_summary.disk_management_status == 'failed' %}
                - DISK MANAGEMENT FAILED: File system issues - verify boot capability before reboot
                {% endif %}
                {% if final_status_summary.security_status == 'failed' %}
                - SECURITY ROLE FAILED: System may be in inconsistent security state - verify SSH access
                {% endif %}

                [RECOVERY_INFORMATION]
                backup_locations: /var/backups/ansible-*/
                individual_role_logs: /var/lib/ansible/*-role-status
                playbook_logs: /var/lib/ansible/playbook-*-status

                [NEXT_STEPS]
                {% if overall_orchestration_status == 'complete_success' %}
                - All provisioning completed successfully
                - System is ready for application deployment
                - Consider running validation tests
                {% elif overall_orchestration_status == 'partial_success' %}
                - Review failed playbooks and resolve issues
                - Re-run site.yml to complete remaining configurations
                - Check dependency requirements for failed roles
                {% elif overall_orchestration_status == 'failed' %}
                - Critical failures detected - manual intervention required
                - Check individual role status files for detailed error information
                - Review backup files for recovery procedures
                - DO NOT REBOOT until system integrity is verified
                {% endif %}
            dest: /var/lib/ansible/orchestration-final-report
            mode: '0644'
            owner: root
            group: root

      - name: Display final orchestration summary
        debug:
            msg: |
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                Domain-Based Provisioning System - FINAL SUMMARY
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                Overall Status: {{ overall_orchestration_status | upper }}
                Success Rate: {{ ((orchestration_stats.successful_count | int / total_playbooks | int) * 100) | round(1) }}%

                Executed: {{ orchestration_stats.executed_count }}/{{ total_playbooks }}
                Successful: {{ orchestration_stats.successful_count }}
                Failed: {{ orchestration_stats.failed_count }}
                Not Executed: {{ orchestration_stats.not_executed_count }}

                Phase Results:
                ğŸ”§ Foundation: Base [{{ final_status_summary.base_status }}] | Software [{{ final_status_summary.software_status }}]
                âš™ï¸  System Config: Settings [{{ final_status_summary.system_settings_status }}] | Disk [{{ final_status_summary.disk_management_status }}]
                ğŸ‘¤ Identity/Infra: Users [{{ final_status_summary.identity_status }}] | Directories [{{ final_status_summary.directories_status }}] | Network [{{ final_status_summary.networking_status }}]
                ğŸ”’ Security: Hardening [{{ final_status_summary.security_status }}]

                {% if overall_orchestration_status == 'complete_success' %}
                âœ… PROVISIONING COMPLETE - System ready for applications
                {% elif overall_orchestration_status == 'partial_success' %}
                âš ï¸  PARTIAL SUCCESS - Review failed components
                {% elif overall_orchestration_status == 'failed' %}
                âŒ CRITICAL FAILURES - Manual intervention required
                {% endif %}

                ğŸ“‹ Full Report: /var/lib/ansible/orchestration-final-report
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      - name: Set final orchestration status for external tools
        set_fact:
            site_orchestration_status: '{{ overall_orchestration_status }}'
            site_success_rate: '{{ ((orchestration_stats.successful_count | int / total_playbooks | int) * 100) | round(1) }}'
