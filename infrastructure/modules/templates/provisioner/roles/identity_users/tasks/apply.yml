---
# Identity & Users Role - Apply Phase
# Creates/manages users, SSH configurations, groups, and permissions

- name: Ensure required groups exist
  group:
      name: '{{ item }}'
      state: present
  loop:
      - sudo
      - adm
      - ansible
      - ssh
  register: system_groups

- name: Create user accounts
  user:
      name: '{{ item.username }}'
      groups: '{{ item.groups | default([]) }}'
      shell: "{{ item.shell | default('/bin/bash') }}"
      home: '/home/{{ item.username }}'
      create_home: true
      password: "{{ item.hashed_passwd | default('*') }}"
      password_lock: '{{ item.lock_passwd | default(false) }}'
      state: present
      append: true
  loop: '{{ users }}'
  register: user_creation
  notify:
      - restart ssh service

- name: Set user passwords if provided
  user:
      name: '{{ item.username }}'
      password: '{{ item.hashed_passwd }}'
  loop: '{{ users }}'
  when:
      - item.hashed_passwd is defined
      - item.hashed_passwd != ""
      - item.hashed_passwd != "*"
  register: password_updates
  no_log: true

- name: Configure sudo access for users
  lineinfile:
      path: '/etc/sudoers.d/{{ item.username }}'
      line: "{{ item.username }} ALL=(ALL:ALL) {{ 'NOPASSWD:' if item.sudo_nopasswd | default(false) else '' }}ALL"
      state: present
      mode: '0440'
      create: true
      validate: 'visudo -cf %s'
  loop: '{{ users }}'
  when: item.sudo | default(false)
  register: sudo_config

- name: Create SSH directories for users
  file:
      path: '/home/{{ item.username }}/.ssh'
      state: directory
      owner: '{{ item.username }}'
      group: '{{ item.username }}'
      mode: '0700'
  loop: '{{ users }}'
  register: ssh_dirs

- name: Configure SSH authorized keys
  authorized_key:
      user: '{{ item.username }}'
      key: "{{ item.ssh_authorized_keys | join('\n') }}"
      state: present
      exclusive: true
  loop: '{{ users }}'
  when:
      - item.ssh_authorized_keys is defined
      - item.ssh_authorized_keys | length > 0
  register: ssh_keys_config

- name: Create SSH client configuration for users
  template:
      src: ssh_config.j2
      dest: '/home/{{ item.username }}/.ssh/config'
      owner: '{{ item.username }}'
      group: '{{ item.username }}'
      mode: '0600'
  loop: '{{ users }}'
  when: item.ssh_client_config is defined
  register: ssh_client_configs

- name: Configure SSH daemon settings
  template:
      src: sshd_config.j2
      dest: /etc/ssh/sshd_config
      owner: root
      group: root
      mode: '0600'
      backup: true
  register: sshd_config
  notify:
      - restart ssh service

- name: Generate SSH host keys if missing
  shell: |
      if [ ! -f /etc/ssh/ssh_host_rsa_key ]; then
        ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key -N '' -q
      fi
      if [ ! -f /etc/ssh/ssh_host_ed25519_key ]; then
        ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N '' -q
      fi
  register: host_keys_generation
  changed_when: "'Generating' in host_keys_generation.stdout"

- name: Set proper permissions on SSH host keys
  file:
      path: '{{ item }}'
      mode: '0600'
      owner: root
      group: root
  loop:
      - /etc/ssh/ssh_host_rsa_key
      - /etc/ssh/ssh_host_ed25519_key
  register: host_key_permissions

- name: Configure login.defs for secure defaults
  lineinfile:
      path: /etc/login.defs
      regexp: '{{ item.regexp }}'
      line: '{{ item.line }}'
      backup: true
  loop:
      - { regexp: '^PASS_MAX_DAYS', line: 'PASS_MAX_DAYS 90' }
      - { regexp: '^PASS_MIN_DAYS', line: 'PASS_MIN_DAYS 1' }
      - { regexp: '^PASS_WARN_AGE', line: 'PASS_WARN_AGE 7' }
      - { regexp: '^UMASK', line: 'UMASK 0027' }
  register: login_defs_config

- name: Configure PAM password requirements (if applicable)
  lineinfile:
      path: /etc/pam.d/common-password
      regexp: '^password.*pam_unix\.so'
      line: 'password [success=1 default=ignore] pam_unix.so obscure sha512 rounds=500000 minlen=8'
      backup: true
  when: ansible_os_family == "Debian"
  register: pam_password_config
  failed_when: false

- name: Set secure permissions on user home directories
  file:
      path: '/home/{{ item.username }}'
      mode: '0750'
      owner: '{{ item.username }}'
      group: '{{ item.username }}'
  loop: '{{ users }}'
  register: home_permissions

- name: Create user profile configurations
  template:
      src: user_profile.j2
      dest: '/home/{{ item.username }}/.profile'
      owner: '{{ item.username }}'
      group: '{{ item.username }}'
      mode: '0644'
  loop: '{{ users }}'
  register: user_profiles

- name: Ensure users are added to specified groups
  user:
      name: '{{ item.0.username }}'
      groups: '{{ item.1 }}'
      append: true
  loop: "{{ users | subelements('groups', skip_missing=True) }}"
  register: group_memberships

- name: Lock system accounts that shouldn't be used for login
  user:
      name: '{{ item }}'
      password_lock: true
      shell: /usr/sbin/nologin
  loop:
      - daemon
      - bin
      - sys
      - sync
      - games
      - man
      - lp
      - mail
      - news
      - uucp
      - proxy
      - www-data
      - backup
      - list
      - irc
      - nobody
  failed_when: false
  register: system_account_lockdown

- name: Set correct ownership on SSH authorized_keys files
  file:
      path: '/home/{{ item.username }}/.ssh/authorized_keys'
      owner: '{{ item.username }}'
      group: '{{ item.username }}'
      mode: '0600'
  loop: '{{ users }}'
  when:
      - item.ssh_authorized_keys is defined
      - item.ssh_authorized_keys | length > 0
  register: authorized_keys_permissions

- name: Force SSH service restart to apply configuration
  meta: flush_handlers

- name: Log apply phase completion
  debug:
      msg:
          - 'Identity & Users apply phase completed'
          - 'Users configured: {{ users | length }}'
          - 'SSH service configuration updated'
          - 'Security defaults applied'
          - 'System accounts locked down'
