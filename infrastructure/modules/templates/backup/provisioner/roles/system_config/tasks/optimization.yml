---
- name: Apply network optimization
  sysctl:
      name: '{{ item.key }}'
      value: '{{ item.value }}'
      state: present
      reload: true
  loop:
      - { key: 'net.core.rmem_max', value: '134217728' }
      - { key: 'net.core.wmem_max', value: '134217728' }
      - { key: 'net.ipv4.tcp_rmem', value: '4096 87380 134217728' }
      - { key: 'net.ipv4.tcp_wmem', value: '4096 65536 134217728' }
      - { key: 'net.core.netdev_max_backlog', value: '5000' }
      - { key: 'net.ipv4.tcp_window_scaling', value: '1' }
      - { key: 'net.ipv4.tcp_timestamps', value: '1' }
      - { key: 'net.ipv4.tcp_sack', value: '1' }
      - { key: 'net.ipv4.tcp_congestion_control', value: 'bbr' }
  when: optimization.enable_network_optimization | default(false)

- name: Apply filesystem optimization
  sysctl:
      name: '{{ item.key }}'
      value: '{{ item.value }}'
      state: present
      reload: true
  loop:
      - { key: 'vm.swappiness', value: '10' }
      - { key: 'vm.vfs_cache_pressure', value: '50' }
      - { key: 'vm.dirty_ratio', value: '15' }
      - { key: 'vm.dirty_background_ratio', value: '5' }
      - { key: 'fs.file-max', value: '2097152' }
  when: optimization.enable_fs_optimization | default(false)

- name: Configure I/O scheduler for storage nodes
  block:
      - name: Set I/O scheduler to mq-deadline for storage devices
        shell: echo mq-deadline > /sys/block/{{ item }}/queue/scheduler
        loop:
            - sdb
            - sdc
            - sdd
        ignore_errors: true
        when: "'storage' in group_names"
  when: optimization.enable_fs_optimization | default(false)
