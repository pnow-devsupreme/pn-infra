# SSH Daemon Configuration - Generated by Ansible - SAFE VERSION
Port 22
AddressFamily any
ListenAddress 0.0.0.0

# Protocol and Ciphers
Protocol 2
{% if security.ssh.disable_weak_algorithms | default(false) %}
KexAlgorithms curve25519-sha256@libssh.org,ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group14-sha256,diffie-hellman-group16-sha512
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr
MACs hmac-sha2-256-etm@openssh.com,hmac-sha2-512-etm@openssh.com,hmac-sha2-256,hmac-sha2-512
{% endif %}

# Authentication - FIXED LOGIC
PermitRootLogin no
StrictModes yes
MaxAuthTries 3
MaxSessions 2
PubkeyAuthentication yes
# FIXED: Use correct variable for password authentication
PasswordAuthentication yes
PermitEmptyPasswords no
ChallengeResponseAuthentication no
KerberosAuthentication no
GSSAPIAuthentication no

# Login and Connection Settings
LoginGraceTime {{ security.ssh.login_grace_time_secs | default(60) }}
MaxStartups {{ security.ssh.max_startups | default(3) }}:30:10
ClientAliveInterval 300
ClientAliveCountMax 2

# Environment and Forwarding
PermitUserEnvironment {{ 'yes' if security.ssh.permit_user_environment | default(false) else 'no' }}
Compression {{ 'yes' if security.ssh.compression | default(false) else 'no' }}
TCPKeepAlive {{ 'yes' if security.ssh.tcp_keep_alive | default(true) else 'no' }}
AllowTcpForwarding {{ 'yes' if security.ssh.allow_tcp_forwarding | default(true) else 'no' }}
AllowStreamLocalForwarding {{ 'yes' if security.ssh.allow_stream_local_forwarding | default(true) else 'no' }}
GatewayPorts {{ 'yes' if security.ssh.gateway_ports | default(false) else 'no' }}
PermitTunnel {{ 'yes' if security.ssh.permit_tunnel | default(false) else 'no' }}

# Logging
SyslogFacility AUTHPRIV
LogLevel INFO

# Banner and Legal
Banner /etc/issue.net
PrintMotd yes
PrintLastLog yes

# Subsystem
Subsystem sftp /usr/lib/openssh/sftp-server -f AUTHPRIV -l INFO
