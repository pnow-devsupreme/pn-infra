---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-backup-config
  namespace: postgres-operator
  labels:
    app.kubernetes.io/name: postgres-operator
    app.kubernetes.io/component: backup-config
data:
  # AWS Configuration
  AWS_REGION: "ap-south-2"
  AWS_ENDPOINT: ""  # Use default AWS S3 endpoint
  AWS_S3_FORCE_PATH_STYLE: "false"  # AWS S3 uses virtual-hosted style
  AWS_EC2_METADATA_DISABLED: "true"

  # WAL-G S3 Configuration for PITR
  WALG_S3_PREFIX: "s3://pn-platform-db-backups/wal"
  WALG_S3_SSE: "AES256"  # Server-side encryption (not KMS, use AES256 for AWS managed)
  WALG_S3_STORAGE_CLASS: "STANDARD"
  WALG_DISABLE_S3_SSE: "false"

  # WAL-G Compression and Performance
  WALG_COMPRESSION_METHOD: "lz4"
  WALG_UPLOAD_CONCURRENCY: "2"
  WALG_DOWNLOAD_CONCURRENCY: "2"

  # WAL-G Backup Settings
  WALG_BACKUP_COMPRESSION_METHOD: "lz4"
  WALG_DELTA_MAX_STEPS: "6"  # Number of delta backups before full backup

  # WAL-G Logging (must be NORMAL, DEVEL, or ERROR)
  WALG_LOG_LEVEL: "NORMAL"
  WALG_S3_LOG_LEVEL: "NORMAL"

  # Enable WAL-G for backup and restore
  USE_WALG_BACKUP: "true"
  USE_WALG_RESTORE: "true"
  CLONE_USE_WALG_RESTORE: "true"

  # Backup retention (keep 7 days of backups)
  BACKUP_SCHEDULE: "0 1 * * *"  # Daily at 1 AM (before logical backup at 2 AM)
  BACKUP_NUM_TO_RETAIN: "7"
