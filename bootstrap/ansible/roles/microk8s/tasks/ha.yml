---
- name: Get node token from primary master
  command: microk8s add-node
  register: add_node_output
  changed_when: false
  when: inventory_hostname == groups['masters'][0]

- name: Extract join command for other masters
  set_fact:
    master_join_command: "{{ add_node_output.stdout_lines | select('match', 'microk8s join.*') | first }}"
  when: inventory_hostname == groups['masters'][0] and add_node_output.stdout is defined

- name: Share join command with other masters
  set_fact:
    master_join_command: "{{ hostvars[groups['masters'][0]]['master_join_command'] }}"
  when: inventory_hostname != groups['masters'][0]

- name: Join secondary masters to the cluster
  command: "{{ master_join_command }}"
  register: join_result
  failed_when: join_result.rc != 0 and 'already exists' not in join_result.stderr
  changed_when: join_result.rc == 0
  when: 
    - inventory_hostname != groups['masters'][0]
    - master_join_command is defined
