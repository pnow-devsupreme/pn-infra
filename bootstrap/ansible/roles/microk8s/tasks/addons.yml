---
- name: Enable MicroK8s addons
  command: "microk8s enable {{ item }}"
  with_items: "{{ enable_addons }}"
  register: addon_result
  changed_when: "'already enabled' not in addon_result.stdout"
  when: inventory_hostname == groups['masters'][0]

- name: Configure MetalLB
  command: "microk8s enable metallb:{{ metallb_address_pool }}"
  register: metallb_result
  changed_when: "metallb_result.stdout is defined and 'already enabled' not in metallb_result.stdout"
  when:
    - inventory_hostname == groups['masters'][0]
    - metallb_enabled | bool
  async: 300 # 5 minute timeout
  poll: 15 # Check every 15 seconds
