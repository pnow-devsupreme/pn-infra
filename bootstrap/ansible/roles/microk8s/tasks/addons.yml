---
- name: Enable MicroK8s addons
  command: microk8s enable {{ item }}
  loop: "{{ enable_addons }}"
  register: addon_results
  ignore_errors: true
  loop_control:
    label: "{{ item }}"
  when: inventory_hostname == groups['masters'][0]

- name: Fail if any addons failed
  fail:
    msg: "Failed to enable addon {{ item.item }}: {{ item.stderr | default(item.stdout) }}"
  loop: "{{ addon_results.results }}"
  when:
    - item.rc != 0
    - "'already enabled' not in (item.stderr|default(''))"

- name: Mark changes only for newly enabled addons
  set_fact:
    addons_changed: >-
      {{
        addon_results.results
        | selectattr('stdout','search','enabled successfully')
        | map(attribute='item')
        | list
      }}
  when: addon_results is defined

- name: Debug which addons were actually enabled
  debug:
    msg: "Newly enabled addons: {{ addons_changed }}"
  when: addons_changed | length > 0

- name: Configure MetalLB (address-pool={{ metallb_address_pool }})
  command: microk8s enable metallb:{{ metallb_address_pool }}
  register: metallb_result
  ignore_errors: true
  when:
    - inventory_hostname == groups['masters'][0]
    - metallb_enabled | bool

- name: Fail if MetalLB truly failed
  fail:
    msg: "MetalLB enable failed: {{ metallb_result.stderr | default(metallb_result.stdout) }}"
  when:
    - metallb_enabled | bool
    - metallb_result is defined
    - metallb_result.rc != 0
    - "'already enabled' not in (metallb_result.stderr|default(''))"

- name: Report MetalLB status
  debug:
    msg: >-
      MetalLB was
      {{ 'already enabled' if metallb_result.stdout is search('already enabled') else 'enabled successfully' }}.
  when:
    - metallb_enabled | bool
    - metallb_result is defined
