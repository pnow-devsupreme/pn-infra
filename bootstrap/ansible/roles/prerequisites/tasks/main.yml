---
- include_tasks: hosts.yml
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install required packages
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - software-properties-common
      - python3-pip
      - net-tools
      - iptables
      - openssh-server
      - snapd
      - ufw
      - unattended-upgrades
    state: present

- name: Configure system settings for Kubernetes
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { key: net.ipv4.ip_forward, value: "1" }
    - { key: net.bridge.bridge-nf-call-iptables, value: "1" }
    - { key: net.bridge.bridge-nf-call-ip6tables, value: "1" }
    - { key: vm.swappiness, value: "0" }

- name: Disable swap
  command: swapoff -a
  when: ansible_swaptotal_mb > 0

- name: Remove swap from fstab
  mount:
    name: swap
    fstype: swap
    state: absent

- name: Load required kernel modules
  modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - br_netfilter
    - overlay
  ignore_errors: yes

- name: Persist required kernel modules
  copy:
    dest: /etc/modules-load.d/kubernetes.conf
    content: |
      br_netfilter
      overlay
    mode: 0644

##############################################
# 🛡️ Firewall setup (masters & workers)
##############################################
- include_tasks: firewall.yml

- name: Set default UFW policies
  ufw:
    state: enabled
    direction: incoming
    policy: deny

- name: Allow all outgoing traffic
  ufw:
    direction: outgoing
    policy: allow

- name: Allow SSH (port 22)
  ufw:
    rule: allow
    name: OpenSSH

# Kubernetes control-plane ports (masters)
- name: Allow Kubernetes API server (6443/tcp)
  ufw:
    rule: allow
    port: 6443
    proto: tcp

- name: Allow etcd client ports (2379-2380/tcp)
  ufw:
    rule: allow
    port: 2379:2380
    proto: tcp

- name: Allow kubelet API on control-plane (10250/tcp)
  ufw:
    rule: allow
    port: 10250
    proto: tcp

- name: Allow scheduler & controller-manager
  ufw:
    rule: allow
    port: 10259,10257
    proto: tcp

# Worker node ports
- name: Allow kubelet API (10250/tcp)
  ufw:
    rule: allow
    port: 10250
    proto: tcp

- name: Allow kube-proxy healthz (10256/tcp)
  ufw:
    rule: allow
    port: 10256
    proto: tcp

- name: Allow NodePort services (30000-32767/tcp)
  ufw:
    rule: allow
    port: 30000:32767
    proto: tcp

# CNI overlays until cilium arrives
- name: Allow Flannel VXLAN (8472/udp) and internal overlay (8285/udp)
  ufw:
    rule: allow
    port: 8472,8285
    proto: udp

# DNS & outbound for updates
- name: Allow DNS (53/tcp,53/udp)
  ufw:
    rule: allow
    port: 53
    proto: tcp
- name: Allow DNS (53/udp)
  ufw:
    rule: allow
    port: 53
    proto: udp

- name: Allow outbound HTTP/HTTPS for package updates
  ufw:
    rule: allow
    port: 80,443
    proto: tcp

##############################################
# 🔐 Basic server hardening
##############################################

- name: Disable root login via SSH
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^PermitRootLogin"
    line: "PermitRootLogin no"
    backup: yes

- name: Disable password authentication
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^PasswordAuthentication"
    line: "PasswordAuthentication no"
    backup: yes

- name: Restart SSHD to apply lockdown
  service:
    name: ssh
    state: restarted

- name: Enable unattended security upgrades
  copy:
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";

- name: Display ProficientNow Tech badge
  debug:
    msg: |

      ██████╗ ██████╗  ██████╗ ███████╗██╗ ██████╗██╗███████╗███╗   ██╗████████╗███╗   ██╗ ██████╗ ██╗    ██╗
      ██╔══██╗██╔══██╗██╔═══██╗██╔════╝██║██╔════╝██║██╔════╝████╗  ██║╚══██╔══╝████╗  ██║██╔═══██╗██║    ██║
      ██████╔╝██████╔╝██║   ██║█████╗  ██║██║     ██║█████╗  ██╔██╗ ██║   ██║   ██╔██╗ ██║██║   ██║██║ █╗ ██║
      ██╔═══╝ ██╔══██╗██║   ██║██╔══╝  ██║██║     ██║██╔══╝  ██║╚██╗██║   ██║   ██║╚██╗██║██║   ██║██║███╗██║
      ██║     ██║  ██║╚██████╔╝██║     ██║╚██████╗██║███████╗██║ ╚████║   ██║   ██║ ╚████║╚██████╔╝╚███╔███╔╝
      ╚═╝     ╚═╝  ╚═╝ ╚═════╝ ╚═╝     ╚═╝ ╚═════╝╚═╝╚══════╝╚═╝  ╚═══╝   ╚═╝   ╚═╝  ╚═══╝ ╚═════╝  ╚══╝╚══╝

- name: Security joke and warning
  debug:
    msg: |
      🔒 “Another login attempt? Persistence is admirable, even if success isn't guaranteed.” 😂
      ⚠️ **WARNING:** You are under digital surveillance. Every command is being logged. Proceed with caution!
